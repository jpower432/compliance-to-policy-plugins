# Conforma OPA Plugin

## Configuration

| Configuration          | Description                                                    | Usage                                                                                                                                                            |
|------------------------|----------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `policy-templates`     | A directory where Rego policies are located.                   | They are Rego policies defined by the users. The policies can include data variables that are generated by the plugin defined in the compliance as code language. |
| `policy-output`        | A directory to write OPA configuration data in JSON for checks | All selected or in-scope policies are copied here for use or bundling.                                                                                           |
| `policy-results`       | A directory where OPA results are located.                     | Results of an `ev validate` run are provided her by the user.                                                                                                    |
| `bundle`               | A location for an opa policy bundle.                           | Set this field if you want the plugin to build a policy bundle with all of you check policies. If unset, it will not create a bundle                             |
| `bundle-revision`      | A revision for the produced bundle                             | The default is 1.0. Only set this is if `bundle` is set.                                                                                                         |
| `conforma-policy-path` | A path to write the policy.yaml                                |                                                                                                                                                                  |
| `bundle-location`      | A location for the bundle with OPA policies.                   | By default this is set to the `policy-output` value, if `bundle` is set, that overrides the value. If the OPA bundle is pre-built, this must be provided.        | |

## Build locally

To use locally, you can run `make build` and create a plugin manifest.

```bash
make build
checksum=$(sha256sum "$(go env GOPATH)/bin/opa-plugin" | cut -d ' ' -f 1 )
    cat >  "$(go env GOPATH)/bin/c2p-opa-manifest.json" << EOF
    {
      "metadata": {
        "id": "conforma",
        "description": "Conforma OPA PVP Plugin",
        "version": "0.0.1",
        "types": [
          "pvp"
        ]
      },
      "executablePath": "opa-plugin",
      "sha256": "$checksum",
      "configuration": [
           {
              "name": "policy-results",
              "description": "A directory where OPA results are located.",
              "required": true
            },
            {
              "name": "bundle-location",
              "description": "A location for the bundle with OPA policies.",
              "required": false
            },
            {
              "name": "conforma-policy-path",
              "description": "A path to write the policy.yaml",
              "required": false,
              "default": "."
            },
            {
              "name": "bundle",
              "description": "A location for an opa policy bundle. If unset, no bundle is created.",
              "required": false
            },
            {
              "name": "bundle-revision",
              "description": "A bundle revision if a bundle is created.",
              "required": false,
              "default": "1.0"
            },
            {
              "name": "policy-templates",
              "description": "A directory where Rego policies are located.",
              "required": false
            },
            {
              "name": "policy-output",
              "description": "A directory to copy Rego policies into expected directory structure.",
              "required": false
            }
      ]
    }
    EOF
```